<template>
  <div class="closure-demo">
    <div class="demo-header">
      <span class="icon">ğŸ</span>
      <span class="title">å‡½æ•°ä¸é—­åŒ…</span>
      <span class="subtitle">ç†è§£ä½œç”¨åŸŸé“¾å’Œé—­åŒ…æœºåˆ¶</span>
    </div>

    <div class="intro-text">
      æƒ³è±¡ä½ æœ‰ä¸ª<span class="highlight">èƒŒåŒ…</span>ï¼ˆå‡½æ•°ï¼‰ï¼Œæ¯æ¬¡å‡ºé—¨æ—¶éƒ½ä¼šæŠŠå½“æ—¶çœ‹åˆ°çš„
      <span class="highlight">é£æ™¯</span>ï¼ˆå¤–éƒ¨å˜é‡ï¼‰è£…è¿›å»ã€‚
      <span class="highlight">é—­åŒ…</span>å°±æ˜¯è¿™ä¸ªèƒŒåŒ…â€”â€”å³ä½¿ç¦»å¼€äº†é‚£ä¸ªåœ°æ–¹ï¼Œä½ ä¾ç„¶èƒ½æ‹¿å‡ºå½“æ—¶è£…çš„é£æ™¯
    </div>

    <div class="demo-tabs">
      <button
        v-for="tab in tabs"
        :key="tab.id"
        @click="activeTab = tab.id"
        class="tab-btn"
        :class="{ active: activeTab === tab.id }"
      >
        {{ tab.label }}
      </button>
    </div>

    <!-- å‡½æ•°åŸºç¡€ -->
    <div v-if="activeTab === 'basic'" class="tab-content">
      <div class="function-showcase">
        <div class="code-panel">
          <div class="code-title">å‡½æ•°å£°æ˜æ–¹å¼</div>
          <div class="code-block">
            <div class="code-line comment">// 1. å‡½æ•°å£°æ˜</div>
            <div class="code-line">function greet(name) {</div>
            <div class="code-line indent">return "Hello " + name</div>
            <div class="code-line">}</div>
            <div class="code-line"></div>
            <div class="code-line comment">// 2. å‡½æ•°è¡¨è¾¾å¼</div>
            <div class="code-line">const greet = function(name) {</div>
            <div class="code-line indent">return "Hello " + name</div>
            <div class="code-line">}</div>
            <div class="code-line"></div>
            <div class="code-line comment">// 3. ç®­å¤´å‡½æ•° (ES6)</div>
            <div class="code-line">const greet = (name) => {</div>
            <div class="code-line indent">return "Hello " + name</div>
            <div class="code-line">}</div>
            <div class="code-line"></div>
            <div class="code-line comment">// ç®€åŒ–ç‰ˆï¼ˆå•è¡Œå¯çœç•¥ returnï¼‰</div>
            <div class="code-line">const greet = name => "Hello " + name</div>
          </div>
        </div>

        <div class="playground">
          <div class="playground-title">è¯•è¯•è°ƒç”¨å‡½æ•°</div>
          <div class="input-group">
            <input v-model="functionName" placeholder="è¾“å…¥ä½ çš„åå­—" />
            <button @click="callFunction">è°ƒç”¨</button>
          </div>
          <div class="output">
            <span v-if="functionResult" class="result">{{ functionResult }}</span>
            <span v-else class="placeholder">ç‚¹å‡»"è°ƒç”¨"æŒ‰é’®çœ‹ç»“æœ...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- é—­åŒ…æ¼”ç¤º -->
    <div v-else-if="activeTab === 'closure'" class="tab-content">
      <div class="closure-visual">
        <div class="scenario-selector">
          <button @click="closureScenario = 'counter'" :class="{ active: closureScenario === 'counter' }">
            è®¡æ•°å™¨
          </button>
          <button @click="closureScenario = 'config'" :class="{ active: closureScenario === 'config' }">
            é…ç½®å™¨
          </button>
        </div>

        <div v-if="closureScenario === 'counter'" class="counter-demo">
          <div class="code-panel small">
            <div class="code-line">function createCounter() {</div>
            <div class="code-line indent">let count = 0 <span class="comment">// ç§æœ‰å˜é‡</span></div>
            <div class="code-line indent">return function() {</div>
            <div class="code-line indent indent">count++</div>
            <div class="code-line indent indent">return count</div>
            <div class="code-line indent">}</div>
            <div class="code-line">}</div>
            <div class="code-line"></div>
            <div class="code-line">const counter = createCounter()</div>
          </div>

          <div class="closure-animation">
            <div class="closure-box">
              <div class="box-title">é—­åŒ…ç¯å¢ƒ</div>
              <div class="closure-var">
                <span class="var-label">count = </span>
                <span class="var-value">{{ counterValue }}</span>
              </div>
            </div>

            <div class="controls-area">
              <button @click="incrementCounter" class="action-btn primary">
                è°ƒç”¨ counter()
              </button>
            </div>

            <div class="explanation">
              <p><strong>å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</strong></p>
              <ul>
                <li><code>createCounter()</code> æ‰§è¡Œåï¼Œå±€éƒ¨å˜é‡ <code>count</code> æœ¬è¯¥æ¶ˆå¤±</li>
                <li>ä½†è¿”å›çš„å‡½æ•°"è®°ä½"äº†è¿™ä¸ªå˜é‡ï¼ˆå½¢æˆäº†é—­åŒ…ï¼‰</li>
                <li>æ¯æ¬¡è°ƒç”¨ <code>counter()</code> éƒ½åœ¨è®¿é—®åŒä¸€ä¸ª <code>count</code></li>
                <li>å¤–éƒ¨æ— æ³•ç›´æ¥è®¿é—® <code>count</code>ï¼ˆå®ç°äº†æ•°æ®ç§æœ‰åŒ–ï¼‰</li>
              </ul>
            </div>
          </div>
        </div>

        <div v-else class="config-demo">
          <div class="code-panel small">
            <div class="code-line">function makeMultiplier(times) {</div>
            <div class="code-line indent">return function(n) {</div>
            <div class="code-line indent indent">return n * times</div>
            <div class="code-line indent">}</div>
            <div class="code-line">}</div>
            <div class="code-line"></div>
            <div class="code-line">const double = makeMultiplier(2)</div>
            <div class="code-line">const triple = makeMultiplier(3)</div>
          </div>

          <div class="multiplier-playground">
            <div class="function-list">
              <div class="func-item" @click="activeMultiplier = 'double'" :class="{ active: activeMultiplier === 'double' }">
                <div class="func-name">double = makeMultiplier(2)</div>
                <div class="func-desc">é—­åŒ…æ•è· times = 2</div>
              </div>
              <div class="func-item" @click="activeMultiplier = 'triple'" :class="{ active: activeMultiplier === 'triple' }">
                <div class="func-name">triple = makeMultiplier(3)</div>
                <div class="func-desc">é—­åŒ…æ•è· times = 3</div>
              </div>
            </div>

            <div class="multiplier-input">
              <input v-model.number="multiplyNumber" type="number" placeholder="è¾“å…¥æ•°å­—" />
              <button @click="doMultiply">è®¡ç®—</button>
            </div>

            <div v-if="multiplyResult" class="multiply-result">
              <span class="result-equation">{{ multiplyResult }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä½œç”¨åŸŸé“¾ -->
    <div v-else class="tab-content">
      <div class="scope-chain-demo">
        <div class="nested-visual">
          <div class="scope-level global">
            <div class="level-title">å…¨å±€ä½œç”¨åŸŸ</div>
            <div class="level-vars">
              <span class="var-tag">globalVar = "å…¨å±€"</span>
            </div>

            <div class="scope-level outer">
              <div class="level-title">å¤–å±‚å‡½æ•°ä½œç”¨åŸŸ</div>
              <div class="level-vars">
                <span class="var-tag">outerVar = "å¤–å±‚"</span>
              </div>

              <div class="scope-level inner">
                <div class="level-title">å†…å±‚å‡½æ•°ä½œç”¨åŸŸ</div>
                <div class="level-vars">
                  <span class="var-tag">innerVar = "å†…å±‚"</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="lookup-demo">
          <div class="lookup-title">ğŸ” å˜é‡æŸ¥æ‰¾è¿‡ç¨‹ï¼ˆä½œç”¨åŸŸé“¾ï¼‰</div>
          <div class="lookup-steps">
            <div class="lookup-step" v-for="(step, i) in lookupSteps" :key="i">
              <div class="step-num">{{ i + 1 }}</div>
              <div class="step-content">{{ step }}</div>
            </div>
          </div>

          <div class="lookup-rule">
            <strong>æŸ¥æ‰¾è§„åˆ™ï¼š</strong>
            ä»å½“å‰ä½œç”¨åŸŸå¼€å§‹ï¼Œé€å±‚å‘å¤–æŸ¥æ‰¾ï¼Œç›´åˆ°å…¨å±€ä½œç”¨åŸŸã€‚æ‰¾ä¸åˆ°åˆ™æŠ¥é”™ ReferenceErrorã€‚
          </div>
        </div>
      </div>
    </div>

    <div class="info-box">
      <span class="icon">ğŸ’¡</span>
      <strong>æ ¸å¿ƒæ€æƒ³ï¼š</strong>
      <span v-if="activeTab === 'basic'">å‡½æ•°æ˜¯ JavaScript ä¸­çš„ä¸€ç­‰å…¬æ°‘ï¼Œå¯ä»¥èµ‹å€¼ç»™å˜é‡ã€ä½œä¸ºå‚æ•°ä¼ é€’ã€ä½œä¸ºè¿”å›å€¼ã€‚ç®­å¤´å‡½æ•°æ›´ç®€æ´ï¼Œä¸”ä¸ç»‘å®šè‡ªå·±çš„ thisã€‚</span>
      <span v-else-if="activeTab === 'closure'">é—­åŒ…æ˜¯å‡½æ•°å’Œå£°æ˜è¯¥å‡½æ•°çš„è¯æ³•ç¯å¢ƒçš„ç»„åˆã€‚å®ƒè®©å‡½æ•°å¯ä»¥è®¿é—®å¤–éƒ¨ä½œç”¨åŸŸçš„å˜é‡ï¼Œå³ä½¿å¤–éƒ¨å‡½æ•°å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚é—­åŒ…å¸¸ç”¨äºæ•°æ®ç§æœ‰åŒ–ã€å‡½æ•°å·¥å‚ã€æ¨¡å—åŒ–ç­‰åœºæ™¯ã€‚</span>
      <span v-else>ä½œç”¨åŸŸé“¾æ˜¯ JavaScript æŸ¥æ‰¾å˜é‡çš„æœºåˆ¶ã€‚å½“è®¿é—®ä¸€ä¸ªå˜é‡æ—¶ï¼Œå¼•æ“ä¼šå…ˆåœ¨å½“å‰ä½œç”¨åŸŸæŸ¥æ‰¾ï¼Œæ‰¾ä¸åˆ°å°±å»å¤–å±‚ä½œç”¨åŸŸæ‰¾ï¼Œç›´åˆ°å…¨å±€ä½œç”¨åŸŸã€‚è¿™ç§æœºåˆ¶è®©å†…å±‚å‡½æ•°å¯ä»¥è®¿é—®å¤–å±‚å˜é‡ï¼Œå½¢æˆäº†é—­åŒ…çš„åŸºç¡€ã€‚</span>
    </div>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue'

const activeTab = ref('basic')
const functionName = ref('')
const functionResult = ref('')
const counterValue = ref(0)
const closureScenario = ref('counter')
const activeMultiplier = ref('double')
const multiplyNumber = ref(null)
const multiplyResult = ref('')

const tabs = [
  { id: 'basic', label: 'å‡½æ•°åŸºç¡€' },
  { id: 'closure', label: 'é—­åŒ…' },
  { id: 'scope', label: 'ä½œç”¨åŸŸé“¾' }
]

const lookupSteps = ref([
  'å†…å±‚å‡½æ•°è®¿é—® innerVar â†’ åœ¨å½“å‰ä½œç”¨åŸŸæ‰¾åˆ° âœ“',
  'å†…å±‚å‡½æ•°è®¿é—® outerVar â†’ å½“å‰æ‰¾ä¸åˆ°ï¼Œå‘å¤–å±‚æŸ¥æ‰¾ âœ“',
  'å†…å±‚å‡½æ•°è®¿é—® globalVar â†’ ç»§ç»­å‘å¤–ï¼Œåœ¨å…¨å±€ä½œç”¨åŸŸæ‰¾åˆ° âœ“',
  'å†…å±‚å‡½æ•°è®¿é—® unknownVar â†’ æ‰€æœ‰ä½œç”¨åŸŸéƒ½æ‰¾ä¸åˆ° âœ— ReferenceError'
])

const callFunction = () => {
  if (functionName.value.trim()) {
    functionResult.value = `Hello ${functionName.value}`
  }
}

const incrementCounter = () => {
  counterValue.value++
}

const doMultiply = () => {
  if (multiplyNumber.value !== null) {
    const times = activeMultiplier.value === 'double' ? 2 : 3
    multiplyResult.value = `${multiplyNumber.value} Ã— ${times} = ${multiplyNumber.value * times}`
  }
}
</script>

<style scoped>
.closure-demo {
  border: 1px solid var(--vp-c-divider);
  border-radius: 8px;
  background: var(--vp-c-bg-soft);
  padding: 1rem;
}

.demo-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
}

.demo-header .icon { font-size: 1.25rem; }
.demo-header .title { font-weight: bold; font-size: 1rem; }
.demo-header .subtitle { color: var(--vp-c-text-2); font-size: 0.85rem; margin-left: 0.5rem; }

.intro-text {
  font-size: 0.9rem;
  line-height: 1.6;
  margin-bottom: 1rem;
  color: var(--vp-c-text-1);
}

.highlight {
  background: var(--vp-c-brand-soft);
  color: var(--vp-c-brand);
  padding: 0.1rem 0.3rem;
  border-radius: 4px;
  font-weight: 500;
}

.demo-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  border-bottom: 1px solid var(--vp-c-divider);
  padding-bottom: 0.5rem;
}

.tab-btn {
  background: transparent;
  border: none;
  padding: 0.5rem 1rem;
  cursor: pointer;
  color: var(--vp-c-text-2);
  font-size: 0.9rem;
  border-radius: 6px;
  transition: all 0.2s;
}

.tab-btn:hover {
  background: var(--vp-c-bg-soft);
}

.tab-btn.active {
  background: var(--vp-c-brand);
  color: white;
}

.tab-content {
  min-height: 380px;
}

.function-showcase {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.code-panel {
  background: #1e1e1e;
  border-radius: 6px;
  padding: 0.75rem;
  font-family: 'Monaco', 'Menlo', monospace;
  font-size: 0.8rem;
  color: #d4d4d4;
}

.code-panel.small {
  font-size: 0.75rem;
  padding: 0.5rem;
}

.code-title {
  color: #888;
  font-size: 0.7rem;
  margin-bottom: 0.5rem;
  text-transform: uppercase;
}

.code-line {
  padding: 0.1rem 0;
  line-height: 1.4;
}

.code-line.indent {
  padding-left: 1.5rem;
}

.code-line.indent.indent {
  padding-left: 3rem;
}

.code-line .comment {
  color: #6a9955;
}

.code-line :deep(code) {
  background: #333;
  padding: 0.1rem 0.3rem;
  border-radius: 3px;
}

.playground {
  background: var(--vp-c-bg);
  border-radius: 6px;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.playground-title {
  font-weight: 600;
  color: var(--vp-c-text-1);
  font-size: 0.9rem;
}

.input-group {
  display: flex;
  gap: 0.5rem;
}

.input-group input {
  flex: 1;
  padding: 0.5rem;
  border: 1px solid var(--vp-c-divider);
  border-radius: 6px;
  background: var(--vp-c-bg-soft);
  color: var(--vp-c-text-1);
}

.input-group button {
  background: var(--vp-c-brand);
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  cursor: pointer;
}

.output {
  background: var(--vp-c-bg-soft);
  border-radius: 6px;
  padding: 0.75rem;
  min-height: 2.5rem;
  display: flex;
  align-items: center;
}

.output .result {
  color: var(--vp-c-brand);
  font-weight: 600;
  font-size: 1.1rem;
}

.output .placeholder {
  color: var(--vp-c-text-3);
  font-size: 0.85rem;
}

.scenario-selector {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.scenario-selector button {
  flex: 1;
  padding: 0.5rem;
  background: var(--vp-c-bg);
  border: 1px solid var(--vp-c-divider);
  border-radius: 6px;
  cursor: pointer;
  color: var(--vp-c-text-2);
  transition: all 0.2s;
}

.scenario-selector button:hover {
  border-color: var(--vp-c-brand);
}

.scenario-selector button.active {
  background: var(--vp-c-brand);
  color: white;
  border-color: var(--vp-c-brand);
}

.closure-visual {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.counter-demo {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.closure-animation {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.closure-box {
  background: var(--vp-c-brand-soft);
  border: 2px solid var(--vp-c-brand);
  border-radius: 8px;
  padding: 1rem;
  text-align: center;
}

.box-title {
  font-weight: 600;
  color: var(--vp-c-brand);
  margin-bottom: 0.5rem;
}

.closure-var {
  font-size: 1.5rem;
  font-weight: bold;
}

.var-label {
  color: var(--vp-c-text-2);
}

.var-value {
  color: var(--vp-c-brand);
  font-size: 2rem;
}

.controls-area {
  display: flex;
  justify-content: center;
}

.action-btn {
  background: var(--vp-c-brand);
  color: white;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 6px;
  font-size: 1rem;
  cursor: pointer;
  transition: opacity 0.2s;
}

.action-btn:hover {
  opacity: 0.9;
}

.explanation {
  background: var(--vp-c-bg-alt);
  border-radius: 6px;
  padding: 0.75rem;
  font-size: 0.85rem;
}

.explanation p {
  margin: 0 0 0.5rem 0;
  font-weight: 600;
  color: var(--vp-c-text-1);
}

.explanation ul {
  margin: 0;
  padding-left: 1.2rem;
  color: var(--vp-c-text-2);
  line-height: 1.6;
}

.explanation code {
  background: var(--vp-c-bg-soft);
  padding: 0.1rem 0.3rem;
  border-radius: 3px;
  font-family: monospace;
}

.config-demo {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.multiplier-playground {
  background: var(--vp-c-bg);
  border-radius: 6px;
  padding: 0.75rem;
}

.function-list {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
}

.func-item {
  flex: 1;
  background: var(--vp-c-bg-soft);
  border: 2px solid var(--vp-c-divider);
  border-radius: 6px;
  padding: 0.75rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}

.func-item:hover {
  border-color: var(--vp-c-brand);
}

.func-item.active {
  border-color: var(--vp-c-brand);
  background: var(--vp-c-brand-soft);
}

.func-name {
  font-weight: 600;
  font-family: monospace;
  margin-bottom: 0.25rem;
  color: var(--vp-c-text-1);
}

.func-desc {
  font-size: 0.75rem;
  color: var(--vp-c-text-3);
}

.multiplier-input {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
}

.multiplier-input input {
  flex: 1;
  padding: 0.5rem;
  border: 1px solid var(--vp-c-divider);
  border-radius: 6px;
  background: var(--vp-c-bg-soft);
  color: var(--vp-c-text-1);
}

.multiplier-input button {
  background: var(--vp-c-brand);
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  cursor: pointer;
}

.multiply-result {
  background: var(--vp-c-bg-soft);
  border-radius: 6px;
  padding: 1rem;
  text-align: center;
}

.result-equation {
  font-size: 1.2rem;
  font-weight: bold;
  color: var(--vp-c-brand);
}

.scope-chain-demo {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.nested-visual {
  background: var(--vp-c-bg);
  border-radius: 6px;
  padding: 1rem;
}

.scope-level {
  border: 2px solid var(--vp-c-divider);
  border-radius: 6px;
  padding: 0.75rem;
  position: relative;
}

.scope-level.global {
  background: #f5f5f5;
}

.scope-level.outer {
  background: #e8f5e9;
  margin: 0.5rem 0 0.5rem 0.5rem;
  border-color: #c8e6c9;
}

.scope-level.inner {
  background: #e3f2fd;
  margin: 0.5rem 0 0 0.5rem;
  border-color: #bbdefb;
}

.level-title {
  font-weight: 600;
  font-size: 0.85rem;
  margin-bottom: 0.5rem;
  text-transform: uppercase;
  color: var(--vp-c-text-2);
}

.level-vars {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.var-tag {
  background: white;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.8rem;
  font-family: monospace;
  border: 1px solid var(--vp-c-divider);
}

.lookup-demo {
  background: var(--vp-c-bg-alt);
  border-radius: 6px;
  padding: 0.75rem;
}

.lookup-title {
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: var(--vp-c-text-1);
}

.lookup-steps {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
}

.lookup-step {
  display: flex;
  gap: 0.5rem;
  align-items: flex-start;
}

.step-num {
  background: var(--vp-c-brand);
  color: white;
  width: 1.5rem;
  height: 1.5rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: 600;
  flex-shrink: 0;
}

.step-content {
  font-size: 0.85rem;
  color: var(--vp-c-text-2);
  line-height: 1.4;
}

.lookup-rule {
  background: white;
  padding: 0.5rem;
  border-radius: 4px;
  font-size: 0.85rem;
  color: var(--vp-c-text-2);
}

.info-box {
  background: var(--vp-c-bg-alt);
  padding: 0.75rem;
  border-radius: 6px;
  font-size: 0.85rem;
  color: var(--vp-c-text-2);
  margin-top: 0.75rem;
  display: flex;
  gap: 0.25rem;
}

.info-box .icon { flex-shrink: 0; }

@media (max-width: 768px) {
  .function-showcase {
    grid-template-columns: 1fr;
  }

  .counter-demo {
    grid-template-columns: 1fr;
  }
}
</style>
